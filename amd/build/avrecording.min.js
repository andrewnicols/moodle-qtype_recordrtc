define ("qtype_recordrtc/avrecording",["exports","core/log","core/modal_factory","https://unpkg.com/mp3-mediarecorder@4.0.5/dist/index.umd.js"],function(a,b,c,d){"use strict";Object.defineProperty(a,"__esModule",{value:!0});a.init=function(a,b){M.util.js_pending("init-"+a);new j(a,b);M.util.js_complete("init-"+a)};b=e(b);c=e(c);function e(a){return a&&a.__esModule?a:{default:a}}var k=URL.createObjectURL(new Blob(["importScripts('https://unpkg.com/mp3-mediarecorder@4.0.5/worker/index.umd.js');","mp3EncoderWorker.initMp3MediaEncoder({vmsgWasmUrl: 'https://unpkg.com/vmsg@0.4.0/vmsg.wasm'});"],{type:"application/javascript"}));function f(){if(!(navigator.mediaDevices&&window.MediaRecorder)){return"nowebrtc"}if(!("https:"===location.protocol||-1!==location.host.indexOf("localhost"))){return"nothttps"}return"ok"}function g(a,c,e,f,g,h,i,j,l){var J=this,K=null,L=null,N=[],O=0,P=0,Q=0;g.addEventListener("click",m);this.uploadMediaToServer=function(){D("uploadpreparing");var a=new XMLHttpRequest;a.open("GET",e.src);a.responseType="blob";a.addEventListener("load",y);a.send()};function m(a){b.default.debug("Start/stop button clicked.");a.preventDefault();switch(g.dataset.state){case"new":case"recorded":n();break;case"starting":p();break;case"recording":r();break;}}function n(){if(a.hidePlayerDuringRecording){e.parentElement.classList.add("hide");f.classList.remove("hide");f.textContent="\xA0"}else{e.parentElement.classList.remove("hide");f.classList.add("hide")}g.classList.remove("btn-outline-danger");g.classList.add("btn-danger");H();N=[];O=0;b.default.debug("Audio/video question: Starting recording with media constraints");b.default.debug(a.mediaConstraints);navigator.mediaDevices.getUserMedia(a.mediaConstraints).then(o).catch(t)}function o(b){K=b;e.srcObject=b;e.muted=!0;if(a.hidePlayerDuringRecording){p()}else{e.play();e.controls=!1;g.dataset.state="starting";D("startrecording")}g.disabled=!1;g.focus()}function p(){var a=F();b.default.debug("Audio/video question: creating recorder with opptions");b.default.debug(a);L=new d.Mp3MediaRecorder(K,{worker:new Worker(k)});L.ondataavailable=q;L.onstop=s;b.default.debug("Audio/video question: starting recording.");L.start(1e3);g.dataset.state="recording";u()}function q(a){b.default.debug("Audio/video question: chunk of "+a.data.size+" bytes received.");O+=a.data.size;if(0<=j.maxUploadSize&&O>=j.maxUploadSize){if(!localStorage.getItem("alerted")){localStorage.setItem("alerted","true");r();i.showAlert("nearingmaxsize")}else{localStorage.removeItem("alerted")}}N.push(a.data);if("undefined"!=typeof M.core_formchangechecker&&!window.location.pathname.endsWith("/question/preview.php")){M.core_formchangechecker.set_form_changed()}}function r(){g.disabled=!0;v();g.classList.remove("btn-danger");g.classList.add("btn-outline-danger");b.default.debug("Audio/video question: stopping recording.");L.stop();for(var a=K.getTracks(),c=0;c<a.length;c++){a[c].stop()}}function s(){if("new"===g.dataset.state){return}b.default.debug("Audio/video question: recording stopped.");var a=new Blob(N,{type:L.mimeType});e.srcObject=null;e.src=URL.createObjectURL(a);e.muted=!1;e.controls=!0;e.parentElement.classList.remove("hide");f.classList.add("hide");e.focus();g.disabled=!0;g.classList.remove("btn-danger");g.classList.add("btn-outline-danger");g.dataset.state="recorded";if(0<N.length){i.notifyRecordingComplete(J)}}function t(a){b.default.debug("Audio/video question: error received");b.default.debug(a);E("recordingfailed");D("recordagain");g.classList.remove("btn-danger");g.classList.add("btn-outline-danger");g.dataset.state="new";if(L){L.stop()}var c="gum"+a.name.replace("Error","").toLowerCase();i.showAlert(c);G()}function u(){P=c;w();Q=setInterval(w,1e3)}function v(){if(0!==Q){clearInterval(Q);Q=0}}function w(){var a=P%60,b=Math.round((P-a)/60);D("recordinginprogress",x(b)+":"+x(a));if(-1===P){r()}P-=1}function x(a){var b=a+"";if(2>b.length){return"0"+b}else{return b}}function y(a){var b=a.target;if(200!==b.status){return}var c=b.response,d=new FormData;d.append("repo_upload_file",c,h);d.append("sesskey",M.cfg.sesskey);d.append("repo_id",j.uploadRepositoryId);d.append("itemid",j.draftItemId);d.append("savepath","/");d.append("ctx_id",j.contextId);d.append("overwrite",1);var e=new XMLHttpRequest;e.addEventListener("readystatechange",z);e.upload.addEventListener("progress",A);e.addEventListener("error",B);e.addEventListener("abort",C);e.open("POST",M.cfg.wwwroot+"/repository/repository_ajax.php?action=upload");e.send(d)}function z(a){var b=a.target;if(4===b.readyState&&200===b.status){D("recordagain");G()}else if(404===b.status){E("uploadfailed404");G()}}function A(a){D("uploadprogress",Math.round(100*(a.loaded/a.total))+"%")}function B(){E("uploadfailed");G()}function C(){E("uploadaborted");G()}function D(b,c){g.innerText=M.util.get_string(b,"qtype_recordrtc",c)}function E(b,c){f.textContent=M.util.get_string(b,"qtype_recordrtc",c);e.parentElement.classList.add("hide");f.classList.remove("hide")}function F(){var b={};if("audio"===a.name){b.audioBitsPerSecond=parseInt(j.audioBitRate,10)}else if("video"===a.name){b.videoBitsPerSecond=parseInt(j.videoBitRate,10);b.videoWidth=parseInt(j.videoWidth,10);b.videoHeight=parseInt(j.videoHeight,10)}for(var c=0;c<a.mimeTypes.length;c++){if(d.Mp3MediaRecorder.isTypeSupported(a.mimeTypes[c])){b.mimeType=a.mimeTypes[c];break}}return b}function G(){I(!0);i.notifyButtonStatesChanged()}function H(){I(!1)}function I(){var a=0<arguments.length&&arguments[0]!==void 0?arguments[0]:!1;l.querySelectorAll("button, input[type=submit], input[type=button]").forEach(function(b){b.disabled=!a})}}function h(){this.name="audio";this.hidePlayerDuringRecording=!0;this.mediaConstraints={audio:!0};this.mimeTypes=["audio/mpeg"]}function i(a,b){this.name="video";this.hidePlayerDuringRecording=!1;this.mediaConstraints={audio:!0,video:{width:{ideal:a},height:{ideal:b}}};this.mimeTypes=["video/webm;codecs=vp9,opus","video/webm;codecs=h264,opus","video/webm;codecs=vp8,opus"]}function j(a,b){var j=document.getElementById(a),k=f();if("nothttps"===k){j.querySelector(".https-warning").classList.remove("hide");return}else if("nowebrtc"===k){j.querySelector(".no-webrtc-warning").classList.remove("hide");return}this.showAlert=e;this.notifyRecordingComplete=function(a){a.uploadMediaToServer()};this.notifyButtonStatesChanged=d;var l=this,m=j.querySelectorAll(".audio-widget, .video-widget");m.forEach(function(a){var c=a.dataset.mediaType,d=a.dataset.maxRecordingDuration,e=a.querySelector(".record-button button"),f=a.querySelector(".media-player "+c),k=a.querySelector(".no-recording-placeholder"),m=a.dataset.recordingFilename,n;if("audio"===c){n=new h}else{n=new i(b.videoWidth,b.videoHeight)}new g(n,d,f,k,e,m,l,b,j)});d();function d(){var a=!1;j.querySelectorAll(".audio-widget, .video-widget").forEach(function(b){if("recorded"===b.querySelector(".record-button button").dataset.state){a=!0}});var b=j.querySelector("input.submit[type=submit]");if(b){b.disabled=!a}}function e(a){return c.default.create({type:c.default.types.ALERT,title:M.util.get_string(a+"_title","qtype_recordrtc"),body:M.util.get_string(a,"qtype_recordrtc")}).then(function(a){a.show();return a})}}});
//# sourceMappingURL=avrecording.min.js.map
