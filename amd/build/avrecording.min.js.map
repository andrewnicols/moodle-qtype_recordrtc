{"version":3,"sources":["../src/avrecording.js"],"names":["questionId","settings","M","util","js_pending","RecordRtcQuestion","js_complete","workerURL","URL","createObjectURL","Blob","type","checkCanWork","navigator","mediaDevices","window","MediaRecorder","location","protocol","host","indexOf","Recorder","timelimit","mediaElement","noMediaPlaceholder","button","filename","owner","questionDiv","recorder","mediaStream","mediaRecorder","chunks","bytesRecordedSoFar","secondsRemaining","countdownTicker","addEventListener","handleButtonClick","uploadMediaToServer","setButtonLabel","fetchRequest","XMLHttpRequest","open","src","responseType","handleRecordingFetched","send","e","Log","debug","preventDefault","dataset","state","startRecording","startSaving","stopRecording","hidePlayerDuringRecording","parentElement","classList","add","remove","textContent","disableAllButtons","mediaConstraints","getUserMedia","then","handleCaptureStarting","catch","handleCaptureFailed","stream","srcObject","muted","play","controls","disabled","focus","options","getRecordingOptions","Mp3MediaRecorder","worker","Worker","ondataavailable","handleDataAvailable","onstop","handleRecordingHasStopped","start","startCountdownTimer","event","data","size","maxUploadSize","localStorage","getItem","setItem","showAlert","removeItem","push","core_formchangechecker","pathname","endsWith","set_form_changed","stopCountdownTimer","stop","tracks","getTracks","i","length","blob","mimeType","notifyRecordingComplete","error","setPlaceholderMessage","stringName","name","replace","toLowerCase","enableAllButtons","updateTimerDisplay","setInterval","clearInterval","secs","mins","Math","round","pad","val","valString","target","status","response","formData","FormData","append","cfg","sesskey","uploadRepositoryId","draftItemId","contextId","uploadRequest","handleUploadReadyStateChanged","upload","handleUploadProgress","handleUploadError","handleUploadAbort","wwwroot","readyState","loaded","total","langString","a","innerText","get_string","audioBitsPerSecond","parseInt","audioBitRate","videoBitsPerSecond","videoBitRate","videoWidth","videoHeight","mimeTypes","isTypeSupported","disableOrEnableButtons","notifyButtonStatesChanged","enabled","querySelectorAll","forEach","AudioSettings","audio","VideoSettings","width","height","video","ideal","document","getElementById","result","querySelector","setSubmitButtonState","thisQuestion","recorderElements","widget","mediaType","maxRecordingDuration","recordingFilename","typeInfo","anyRecorded","submitButton","subject","ModalFactory","create","types","ALERT","title","body","modal","show"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n//\n\n/**\n * JavaScript to the recording work.\n *\n * We would like to thank the creators of atto_recordrtc, whose\n * work inspired this.\n *\n * @package   qtype_recordrtc\n * @copyright 2019 The Open University\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Log from 'core/log';\nimport ModalFactory from 'core/modal_factory';\nimport {Mp3MediaRecorder} from 'https://unpkg.com/mp3-mediarecorder@4.0.5/dist/index.umd.js';\n\nconst workerURL = URL.createObjectURL(new Blob([\n        \"import { initMp3MediaEncoder } from 'https://unpkg.com/mp3-mediarecorder@4.0.5/worker/index.es5.js';\",\n        \"initMp3MediaEncoder({vmsgWasmUrl: 'https://unpkg.com/vmsg@0.4.0/vmsg.wasm'});\"\n        ], {type: 'application/javascript'}));\n\n/**\n * Verify that the question type can work. If not, show a warning.\n *\n * @return {string} 'ok' if it looks OK, else 'nowebrtc' or 'nothttps' if there is a problem.\n */\nfunction checkCanWork() {\n    if (!(navigator.mediaDevices && window.MediaRecorder)) {\n        return 'nowebrtc';\n    }\n\n    if (!(location.protocol === 'https:' || location.host.indexOf('localhost') !== -1)) {\n        return 'nothttps';\n    }\n\n    return 'ok';\n}\n\n/**\n * Object for actually doing the recording.\n *\n * The recorder can be in one of 4 states, which is stored in a data-state\n * attribute on the button. The states are:\n *  - new:       there is no recording yet. Button shows 'Start recording'.\n *  - recording: buttons shows a countdown of remaining time. Media is being recorded.\n *  - saving:    buttons shows a progress indicator.\n *  - recorded:  button shows 'Record again'.\n *\n * @param {(AudioSettings|VideoSettings)} type\n * @param {int} timelimit\n * @param {HTMLMediaElement} mediaElement\n * @param {HTMLMediaElement} noMediaPlaceholder\n * @param {HTMLButtonElement} button\n * @param {string} filename the name of the audio (.ogg) or video file (.webm)\n * @param {Object} owner\n * @param {Object} settings\n * @param {Object} questionDiv\n * @constructor\n */\nfunction Recorder(type, timelimit, mediaElement, noMediaPlaceholder,\n                  button, filename, owner, settings, questionDiv) {\n    /**\n     * @type {Recorder} reference to this recorder, for use in event handlers.\n     */\n    var recorder = this;\n\n    /**\n     * @type {MediaStream} during recording, the stream of incoming media.\n     */\n    var mediaStream = null;\n\n    /**\n     * @type {MediaRecorder} the recorder that is capturing stream.\n     */\n    var mediaRecorder = null;\n\n    /**\n     * @type {Blob[]} the chunks of data that have been captured so far duing the current recording.\n     */\n    var chunks = [];\n\n    /**\n     * @type {number} number of bytes recorded so far, so we can auto-stop\n     * before hitting Moodle's file-size limit.\n     */\n    var bytesRecordedSoFar = 0;\n\n    /**\n     * @type {number} time left in seconds, so we can auto-stop at the time limit.\n     */\n    var secondsRemaining = 0;\n\n    /**\n     * @type {number} intervalID returned by setInterval() while the timer is running.\n     */\n    var countdownTicker = 0;\n\n    button.addEventListener('click', handleButtonClick);\n    this.uploadMediaToServer = uploadMediaToServer; // Make this method available.\n\n    /**\n     * Handles clicks on the start/stop button.\n     *\n     * @param {Event} e\n     */\n    function handleButtonClick(e) {\n        Log.debug('Start/stop button clicked.');\n        e.preventDefault();\n        switch (button.dataset.state) {\n            case 'new':\n            case 'recorded':\n                startRecording();\n                break;\n            case 'starting':\n                startSaving();\n                break;\n            case 'recording':\n                stopRecording();\n                break;\n        }\n    }\n\n    /**\n     * Start recording (because the button was clicked).\n     */\n    function startRecording() {\n\n        if (type.hidePlayerDuringRecording) {\n            mediaElement.parentElement.classList.add('hide');\n            noMediaPlaceholder.classList.remove('hide');\n            noMediaPlaceholder.textContent = '\\u00a0';\n        } else {\n            mediaElement.parentElement.classList.remove('hide');\n            noMediaPlaceholder.classList.add('hide');\n        }\n\n        // Change look of recording button.\n        button.classList.remove('btn-outline-danger');\n        button.classList.add('btn-danger');\n\n        // Disable other question buttons when current widget stared recording.\n        disableAllButtons();\n\n        // Empty the array containing the previously recorded chunks.\n        chunks = [];\n        bytesRecordedSoFar = 0;\n        Log.debug('Audio/video question: Starting recording with media constraints');\n        Log.debug(type.mediaConstraints);\n        navigator.mediaDevices.getUserMedia(type.mediaConstraints)\n            .then(handleCaptureStarting)\n            .catch(handleCaptureFailed);\n    }\n\n    /**\n     * Callback once getUserMedia has permission from the user to access the recording devices.\n     *\n     * @param {MediaStream} stream the stream to record.\n     */\n    function handleCaptureStarting(stream) {\n        mediaStream = stream;\n\n        // Setup the UI for during recording.\n        mediaElement.srcObject = stream;\n        mediaElement.muted = true;\n        if (type.hidePlayerDuringRecording) {\n            startSaving();\n        } else {\n            mediaElement.play();\n            mediaElement.controls = false;\n\n            button.dataset.state = 'starting';\n            setButtonLabel('startrecording');\n        }\n\n        // Make button clickable again, to allow starting/stopping recording.\n        button.disabled = false;\n        button.focus();\n    }\n\n    /**\n     * For recording types which show the media during recording,\n     * this starts the loop-back display, but does not start recording it yet.\n     */\n    function startSaving() {\n        // Initialize MediaRecorder events and start recording.\n        var options = getRecordingOptions();\n        Log.debug('Audio/video question: creating recorder with opptions');\n        Log.debug(options);\n        mediaRecorder = new Mp3MediaRecorder(mediaStream,\n            {worker: new Worker(workerURL)});\n\n        mediaRecorder.ondataavailable = handleDataAvailable;\n        mediaRecorder.onstop = handleRecordingHasStopped;\n        Log.debug('Audio/video question: starting recording.');\n        mediaRecorder.start(1000); // Capture in one-second chunks. Firefox requires that.\n\n        button.dataset.state = 'recording';\n        startCountdownTimer();\n    }\n\n    /**\n     * Callback that is called by the media system for each Chunk of data.\n     *\n     * @param {BlobEvent} event\n     */\n    function handleDataAvailable(event) {\n        Log.debug('Audio/video question: chunk of ' + event.data.size + ' bytes received.');\n\n        // Check there is space to store the next chunk, and if not stop.\n        bytesRecordedSoFar += event.data.size;\n        if (settings.maxUploadSize >= 0 && bytesRecordedSoFar >= settings.maxUploadSize) {\n\n            // Extra check to avoid alerting twice.\n            if (!localStorage.getItem('alerted')) {\n                localStorage.setItem('alerted', 'true');\n                stopRecording();\n                owner.showAlert('nearingmaxsize');\n\n            } else {\n                localStorage.removeItem('alerted');\n            }\n        }\n\n        // Store the next chunk of data.\n        chunks.push(event.data);\n\n        // Notify form-change-checker that there is now unsaved data.\n        // But, don't do this in question preview where it is just annoying.\n        if (typeof M.core_formchangechecker !== 'undefined' &&\n            !window.location.pathname.endsWith('/question/preview.php')) {\n            M.core_formchangechecker.set_form_changed();\n        }\n    }\n\n    /**\n     * Start recording (because the button was clicked or because we have reached a limit).\n     */\n    function stopRecording() {\n        // Disable the button while things change.\n        button.disabled = true;\n\n        // Stop the count-down timer.\n        stopCountdownTimer();\n\n        // Update the button.\n        button.classList.remove('btn-danger');\n        button.classList.add('btn-outline-danger');\n\n        // Ask the recording to stop.\n        Log.debug('Audio/video question: stopping recording.');\n        mediaRecorder.stop();\n\n        // Also stop each individual MediaTrack.\n        var tracks = mediaStream.getTracks();\n        for (var i = 0; i < tracks.length; i++) {\n            tracks[i].stop();\n        }\n    }\n\n    /**\n     * Callback that is called by the media system once recording has finished.\n     */\n    function handleRecordingHasStopped() {\n        if (button.dataset.state === 'new') {\n            // This can happens if an error occurs when recording is starting. Do nothing.\n            return;\n        }\n\n        // Set source of audio player.\n        Log.debug('Audio/video question: recording stopped.');\n        var blob = new Blob(chunks, {type: mediaRecorder.mimeType});\n        mediaElement.srcObject = null;\n        mediaElement.src = URL.createObjectURL(blob);\n\n        // Show audio player with controls enabled, and unmute.\n        mediaElement.muted = false;\n        mediaElement.controls = true;\n        mediaElement.parentElement.classList.remove('hide');\n        noMediaPlaceholder.classList.add('hide');\n        mediaElement.focus();\n\n        // Encure the button while things change.\n        button.disabled = true;\n        button.classList.remove('btn-danger');\n        button.classList.add('btn-outline-danger');\n        button.dataset.state = 'recorded';\n\n        if (chunks.length > 0) {\n            owner.notifyRecordingComplete(recorder);\n        }\n    }\n\n    /**\n     * Function that handles errors from the recorder.\n     *\n     * @param {DOMException} error\n     */\n    function handleCaptureFailed(error) {\n        Log.debug('Audio/video question: error received');\n        Log.debug(error);\n\n        setPlaceholderMessage('recordingfailed');\n        setButtonLabel('recordagain');\n        button.classList.remove('btn-danger');\n        button.classList.add('btn-outline-danger');\n        button.dataset.state = 'new';\n\n        if (mediaRecorder) {\n            mediaRecorder.stop();\n        }\n\n        // Changes 'CertainError' -> 'gumcertain' to match language string names.\n        var stringName = 'gum' + error.name.replace('Error', '').toLowerCase();\n\n        owner.showAlert(stringName);\n        enableAllButtons();\n    }\n\n    /**\n     * Start the countdown timer from timeLimit.\n     */\n    function startCountdownTimer() {\n        secondsRemaining = timelimit;\n\n        updateTimerDisplay();\n        countdownTicker = setInterval(updateTimerDisplay, 1000);\n    }\n\n    /**\n     * Stop the countdown timer.\n     */\n    function stopCountdownTimer() {\n        if (countdownTicker !== 0) {\n            clearInterval(countdownTicker);\n            countdownTicker = 0;\n        }\n    }\n\n    /**\n     * Update the countdown timer, and stop recording if we have reached 0.\n     */\n    function updateTimerDisplay() {\n        var secs = secondsRemaining % 60;\n        var mins = Math.round((secondsRemaining - secs) / 60);\n        setButtonLabel('recordinginprogress', pad(mins) + ':' + pad(secs));\n\n        if (secondsRemaining === -1) {\n            stopRecording();\n        }\n        secondsRemaining -= 1;\n    }\n\n    /**\n     * Zero-pad a string to be at least two characters long.\n     *\n     * Used fro\n     * @param {number} val, e.g. 1 or 10\n     * @return {string} e.g. '01' or '10'.\n     */\n    function pad(val) {\n        var valString = val + '';\n\n        if (valString.length < 2) {\n            return '0' + valString;\n        } else {\n            return valString;\n        }\n    }\n\n    /**\n     * Upload the recorded media back to Moodle.\n     */\n    function uploadMediaToServer() {\n        setButtonLabel('uploadpreparing');\n\n        var fetchRequest = new XMLHttpRequest();\n\n        // Get media of audio/video tag.\n        fetchRequest.open('GET', mediaElement.src);\n        fetchRequest.responseType = 'blob';\n        fetchRequest.addEventListener('load', handleRecordingFetched);\n        fetchRequest.send();\n    }\n\n    /**\n     * Callback called once we have the data from the media element.\n     *\n     * @param {ProgressEvent} e\n     */\n    function handleRecordingFetched(e) {\n        var fetchRequest = e.target;\n        if (fetchRequest.status !== 200) {\n            // No data.\n            return;\n        }\n\n        // Blob is now the media that the audio/video tag's src pointed to.\n        var blob = fetchRequest.response;\n\n        // Create FormData to send to PHP filepicker-upload script.\n        var formData = new FormData();\n        formData.append('repo_upload_file', blob, filename);\n        formData.append('sesskey', M.cfg.sesskey);\n        formData.append('repo_id', settings.uploadRepositoryId);\n        formData.append('itemid', settings.draftItemId);\n        formData.append('savepath', '/');\n        formData.append('ctx_id', settings.contextId);\n        formData.append('overwrite', 1);\n\n        var uploadRequest = new XMLHttpRequest();\n        uploadRequest.addEventListener('readystatechange', handleUploadReadyStateChanged);\n        uploadRequest.upload.addEventListener('progress', handleUploadProgress);\n        uploadRequest.addEventListener('error', handleUploadError);\n        uploadRequest.addEventListener('abort', handleUploadAbort);\n        uploadRequest.open('POST', M.cfg.wwwroot + '/repository/repository_ajax.php?action=upload');\n        uploadRequest.send(formData);\n    }\n\n    /**\n     * Callback for when the upload completes.\n     * @param {ProgressEvent} e\n     */\n    function handleUploadReadyStateChanged(e) {\n        var uploadRequest = e.target;\n        if (uploadRequest.readyState === 4 && uploadRequest.status === 200) {\n            // When request finished and successful.\n            setButtonLabel('recordagain');\n            enableAllButtons();\n        } else if (uploadRequest.status === 404) {\n            setPlaceholderMessage('uploadfailed404');\n            enableAllButtons();\n        }\n    }\n\n    /**\n     * Callback for updating the upload progress.\n     * @param {ProgressEvent} e\n     */\n    function handleUploadProgress(e) {\n        setButtonLabel('uploadprogress', Math.round(e.loaded / e.total * 100) + '%');\n    }\n\n    /**\n     * Callback for when the upload fails with an error.\n     */\n    function handleUploadError() {\n        setPlaceholderMessage('uploadfailed');\n        enableAllButtons();\n    }\n\n    /**\n     * Callback for when the upload fails with an error.\n     */\n    function handleUploadAbort() {\n        setPlaceholderMessage('uploadaborted');\n        enableAllButtons();\n    }\n\n    /**\n     * Display a progress message in the upload progress area.\n     *\n     * @param {string} langString\n     * @param {Object|String} a optional variable to populate placeholder with\n     */\n    function setButtonLabel(langString, a) {\n        button.innerText = M.util.get_string(langString, 'qtype_recordrtc', a);\n    }\n\n    /**\n     * Display a message in the upload progress area.\n     *\n     * @param {string} langString\n     * @param {Object|String} a optional variable to populate placeholder with\n     */\n    function setPlaceholderMessage(langString, a) {\n        noMediaPlaceholder.textContent = M.util.get_string(langString, 'qtype_recordrtc', a);\n        mediaElement.parentElement.classList.add('hide');\n        noMediaPlaceholder.classList.remove('hide');\n    }\n\n    /**\n     * Select best options for the recording codec.\n     *\n     * @returns {Object}\n     */\n    function getRecordingOptions() {\n        var options = {};\n\n        // Get the relevant bit rates from settings.\n        if (type.name === 'audio') {\n            options.audioBitsPerSecond = parseInt(settings.audioBitRate, 10);\n        } else if (type.name === 'video') {\n            options.videoBitsPerSecond = parseInt(settings.videoBitRate, 10);\n            options.videoWidth = parseInt(settings.videoWidth, 10);\n            options.videoHeight = parseInt(settings.videoHeight, 10);\n        }\n\n        // Go through our list of mimeTypes, and take the first one that will work.\n        for (var i = 0; i < type.mimeTypes.length; i++) {\n            if (Mp3MediaRecorder.isTypeSupported(type.mimeTypes[i])) {\n                options.mimeType = type.mimeTypes[i];\n                break;\n            }\n        }\n\n        return options;\n    }\n\n    /**\n     * Enable all buttons in the question.\n     */\n    function enableAllButtons() {\n        disableOrEnableButtons(true);\n        owner.notifyButtonStatesChanged();\n    }\n\n    /**\n     * Disable all buttons in the question.\n     */\n    function disableAllButtons() {\n        disableOrEnableButtons(false);\n    }\n\n    /**\n     * Disables/enables other question buttons when current widget started recording/finished recording.\n     *\n     * @param {boolean} enabled true if the button should be enabled.\n     */\n    function disableOrEnableButtons(enabled = false) {\n        questionDiv.querySelectorAll('button, input[type=submit], input[type=button]').forEach(\n            function(button) {\n                button.disabled = !enabled;\n            }\n        );\n    }\n}\n\n/**\n * Object that controls the settings for recording audio.\n *\n * @constructor\n */\nfunction AudioSettings() {\n    this.name = 'audio';\n    this.hidePlayerDuringRecording = true;\n    this.mediaConstraints = {\n        audio: true\n    };\n    this.mimeTypes = [\n        'audio/mpeg',\n    ];\n}\n\n/**\n * Object that controls the settings for recording video.\n *\n * @param {number} width desired width.\n * @param {number} height desired height.\n * @constructor\n */\nfunction VideoSettings(width, height) {\n    this.name = 'video';\n    this.hidePlayerDuringRecording = false;\n    this.mediaConstraints = {\n        audio: true,\n        video: {\n            width: {ideal: width},\n            height: {ideal: height}\n        }\n    };\n    this.mimeTypes = [\n        'video/webm;codecs=vp9,opus',\n        'video/webm;codecs=h264,opus',\n        'video/webm;codecs=vp8,opus'\n    ];\n}\n\n/**\n * Represents one record audio or video question.\n *\n * @param {string} questionId id of the outer question div.\n * @param {Object} settings like audio bit rate.\n * @constructor\n */\nfunction RecordRtcQuestion(questionId, settings) {\n    var questionDiv = document.getElementById(questionId);\n\n    // Check if the RTC API can work here.\n    var result = checkCanWork();\n    if (result === 'nothttps') {\n        questionDiv.querySelector('.https-warning').classList.remove('hide');\n        return;\n    } else if (result === 'nowebrtc') {\n        questionDiv.querySelector('.no-webrtc-warning').classList.remove('hide');\n        return;\n    }\n    // Make the callback functions available.\n    this.showAlert = showAlert;\n    this.notifyRecordingComplete = notifyRecordingComplete;\n    this.notifyButtonStatesChanged = setSubmitButtonState;\n    const thisQuestion = this;\n\n    // We may have more than one widget in a question.\n    var recorderElements = questionDiv.querySelectorAll('.audio-widget, .video-widget');\n    recorderElements.forEach(function(widget) {\n        // Get the key UI elements.\n        var type = widget.dataset.mediaType;\n        var timelimit = widget.dataset.maxRecordingDuration;\n        var button = widget.querySelector('.record-button button');\n        var mediaElement = widget.querySelector('.media-player ' + type);\n        var noMediaPlaceholder = widget.querySelector('.no-recording-placeholder');\n        var filename = widget.dataset.recordingFilename;\n\n        // Get the appropriate options.\n        var typeInfo;\n        if (type === 'audio') {\n            typeInfo = new AudioSettings();\n        } else {\n            typeInfo = new VideoSettings(settings.videoWidth, settings.videoHeight);\n        }\n\n        // Create the recorder.\n        new Recorder(typeInfo, timelimit, mediaElement, noMediaPlaceholder, button,\n                filename, thisQuestion, settings, questionDiv);\n    });\n    setSubmitButtonState();\n\n    /**\n     * Set the state of the question's submit button.\n     *\n     * If any recorder does not yet have a recording, then disable the button.\n     * Otherwise, enable it.\n     */\n    function setSubmitButtonState() {\n        var anyRecorded = false;\n        questionDiv.querySelectorAll('.audio-widget, .video-widget').forEach(function(widget) {\n            if (widget.querySelector('.record-button button').dataset.state === 'recorded') {\n                anyRecorded = true;\n            }\n        });\n        var submitButton = questionDiv.querySelector('input.submit[type=submit]');\n        if (submitButton) {\n            submitButton.disabled = !anyRecorded;\n       }\n    }\n\n    /**\n     * Show a modal alert.\n     *\n     * @param {string} subject Subject is the content of the alert (which error the alert is for).\n     * @return {Promise}\n     */\n    function showAlert(subject) {\n        return ModalFactory.create({\n            type: ModalFactory.types.ALERT,\n            title: M.util.get_string(subject + '_title', 'qtype_recordrtc'),\n            body: M.util.get_string(subject, 'qtype_recordrtc'),\n        }).then(function(modal) {\n            modal.show();\n            return modal;\n        });\n    }\n\n    /**\n     * Callback called when the recording is completed.\n     *\n     * @param {Recorder} recorder the recorder.\n     */\n    function notifyRecordingComplete(recorder) {\n        recorder.uploadMediaToServer();\n    }\n}\n\n/**\n * Initialise a record audio or video question.\n *\n * @param {string} questionId id of the outer question div.\n * @param {Object} settings like audio bit rate.\n */\nfunction init (questionId, settings) {\n    M.util.js_pending('init-' + questionId);\n    new RecordRtcQuestion(questionId, settings);\n    M.util.js_complete('init-' + questionId);\n}\n\nexport {\n    init\n};\n"],"file":"avrecording.min.js"}